<!DOCTYPE html>
<html>
<head>
  <title>Suburb Population Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      width: 100%;
    }
    #map {
      height: 100vh;
      width: 100vw;
      margin: 0;
      padding: 0;
    }
    #colorBy {
      position: absolute;
      z-index: 1000;
      bottom: 140px;
      right: 20px;
      font-size: 24px;
      padding: 12px 48px 12px 24px;
      border-radius: 18px;
      background: #e0f2ff;
      border: 1.5px solid #b3d8f6;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
      outline: none;
      appearance: none;
      transition: box-shadow 0.2s;
      background-image: url('data:image/svg+xml;utf8,<svg fill="%2399c2e6" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
      background-repeat: no-repeat;
      background-position: right 18px center;
      background-size: 24px 24px;
      cursor: pointer;
    }
    .legend {
      position: absolute;
      z-index: 1000;
      bottom: 20px;
      left: 20px;
      background: rgba(255,255,255,0.8);
      padding: 10px;
      border-radius: 5px;
      font-size: 12px;
      line-height: 1.5;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .legend-title {
      font-weight: bold;
      margin-bottom: 5px;
    }
    .legend-scale {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .legend-label {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .legend-color {
      width: 18px;
      height: 12px;
      display: inline-block;
      border: 1px solid #ccc;
    }
    .suburb-label {
      color: #111;
      font-size: 8px;
      pointer-events: none;
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
    }
  </style>
</head>
<body>
  <select id="colorBy">
    <option value="AllotmentArea">Allotment Area</option>
    <option value="ExistingDwelling">Existing Dwelling</option>
    <option value="NewDwellings">New Dwellings</option>
  </select>
  <input type="range" id="yearSlider" min="0" max="4" step="1" value="0" style="position:absolute;z-index:1000;bottom:100px;right:20px;width:220px;">
  <span id="yearLabel" style="position:absolute;z-index:1000;bottom:80px;right:20px;font-size:18px;background:#fff;padding:2px 10px;border-radius:8px;">2025</span>
  <div id="map"></div>
  <div id="legend" class="legend"></div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>

var map = L.map('map').setView([-38.1471, 144.3607], 6);
// Legend color scales for each metric
const legendScales = {
  AllotmentArea: [
    { label: '> 1,000,000', color: '#800026' },
    { label: '500,001 – 1,000,000', color: '#BD0026' },
    { label: '100,001 – 500,000', color: '#E31A1C' },
    { label: '10,001 – 100,000', color: '#FC4E2A' },
    { label: '≤ 10,000', color: '#FFEDA0' }
  ],
  ExistingDwelling: [
    { label: '> 60', color: '#084081' },
    { label: '41 – 60', color: '#0868ac' },
    { label: '21 – 40', color: '#2b8cbe' },
    { label: '11 – 20', color: '#4eb3d3' },
    { label: '≤ 10', color: '#ccebc5' }
  ],
  NewDwellings: [
    { label: '> 200', color: '#54278f' },
    { label: '101 – 200', color: '#756bb1' },
    { label: '51 – 100', color: '#9e9ac8' },
    { label: '11 – 50', color: '#cbc9e2' },
    { label: '≤ 10', color: '#f2f0f7' }
  ]
};

function updateLegend(metric) {
  const legend = document.getElementById('legend');
  const scale = legendScales[metric];
  let html = `<div class="legend-title">${metric.charAt(0).toUpperCase() + metric.slice(1)}</div><div class="legend-scale">`;
  scale.forEach(item => {
    html += `<div class="legend-label"><span class="legend-color" style="background:${item.color}"></span>${item.label}</div>`;
  });
  html += '</div>';
  legend.innerHTML = html;
}

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);



  let geojsonLayer;
  let geojsonData;
  const years = [2025, 2023, 2022, 2021, 2020];
  let currentYear = years[0];

    // Color scales for each metric
function getColor(metric, value) {
  if (metric === 'AllotmentArea') {
    return value > 1000000 ? '#800026' :
           value > 500000  ? '#BD0026' :
           value > 100000  ? '#E31A1C' :
           value > 10000   ? '#FC4E2A' :
                            '#FFEDA0';
  } else if (metric === 'ExistingDwelling') {
    return value > 60 ? '#084081' :
           value > 40 ? '#0868ac' :
           value > 20 ? '#2b8cbe' :
           value > 10 ? '#4eb3d3' :
                        '#ccebc5';
  } else if (metric === 'NewDwellings') {
    return value > 200 ? '#54278f' :
           value > 100 ? '#756bb1' :
           value > 50  ? '#9e9ac8' :
           value > 10  ? '#cbc9e2' :
                        '#f2f0f7';
  }
  return '#ccc';
}

function style(feature, metric, year) {
  const props = feature.properties || {};
  let value = 0;
  if (props.date && props.date[year]) {
    if (metric === 'AllotmentArea') value = props.date[year].AllotmentArea || 0;
    else if (metric === 'ExistingDwelling') value = props.date[year].ExistingDwelling || 0;
    else if (metric === 'NewDwellings') value = props.date[year].NewDwellings || 0;
  }
  return {
    fillColor: getColor(metric, value),
    weight: 2,
    opacity: 1,
    color: 'black',
    fillOpacity: 0.7
  };
}

function renderGeoJson(metric, year) {
  if (geojsonLayer) map.removeLayer(geojsonLayer);
  geojsonLayer = L.geoJson(geojsonData, {
    style: feature => style(feature, metric, year),
    onEachFeature: function (feature, layer) {
      const props = feature.properties || {};
      const suburb = props.loc_name ? props.loc_name.toUpperCase() : '';
      let allotment = 0, existing = 0, newd = 0;
      if (props.date && props.date[year]) {
        allotment = props.date[year].AllotmentArea || 0;
        existing = props.date[year].ExistingDwelling || 0;
        newd = props.date[year].NewDwellings || 0;
      }
      layer.bindPopup(
        `<b>${suburb}</b><br>Allotment Area: ${allotment}<br>Existing Dwellings: ${existing}<br>New Dwellings: ${newd}`
      );
      layer.bindTooltip(suburb, {
        permanent: true,
        direction: "center",
        className: "suburb-label"
      });
    }
  }).addTo(map);
}


    fetch('suburbs_updated_with_dates.geojson')
      .then(res => res.json())
      .then(geojson => {
        geojsonData = geojson;
        // Get the initial metric and year
        const initialMetric = document.getElementById('colorBy').value;
        const initialYear = years[document.getElementById('yearSlider').value];
        currentYear = initialYear;
        renderGeoJson(initialMetric, String(initialYear));
        updateLegend(initialMetric);
      });

    document.getElementById('colorBy').addEventListener('change', function() {
      renderGeoJson(this.value, String(currentYear));
      updateLegend(this.value);
    });

    document.getElementById('yearSlider').addEventListener('input', function() {
      const yearIdx = parseInt(this.value, 10);
      const year = years[yearIdx];
      currentYear = year;
      document.getElementById('yearLabel').textContent = year;
      const metric = document.getElementById('colorBy').value;
      renderGeoJson(metric, String(year));
    });
  </script>
</body>
</html>